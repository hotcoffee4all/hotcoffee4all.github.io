
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wind Budget & Density Altitude</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 1rem;
    }
    input, button {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      margin-top: 0.25rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      margin-top: 1rem;
    }
    button:active {
      background-color: #0056b3;
    }
    .output, .debug {
      margin-top: 1.5rem;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      white-space: pre-wrap;
    }
    .debug {
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>

<h1>Wind Budget & DA Calculator</h1>

<label>Target Size (inches)</label>
<input id="targetSize" type="number" step="0.1">

<label>Distance (yards)</label>
<input id="distance" type="number" step="1">

<label>Wind Hold (mils)</label>
<input id="windHold" type="number" step="0.01">

<label>Temperature (°F)</label>
<input id="temperature" type="number">

<label>Pressure (hPa)</label>
<input id="pressure" type="number">

<label>Humidity (%)</label>
<input id="humidity" type="number">

<label>Elevation (feet)</label>
<input id="elevation" type="number">

<button onclick="getWeather()">Auto-Fill Weather</button>
<button onclick="calculate()">Calculate</button>

<div class="output" id="result">Results will appear here…</div>
<div class="debug" id="debug">Debug log…</div>

<script>
function log(msg) {
  const debugEl = document.getElementById("debug");
  debugEl.textContent += "\n" + msg;
}

function getWeather() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported by this browser.");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    log("Using location: " + lat + ", " + lon);

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,pressure_msl,relative_humidity_2m,elevation`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        const c = data.current;
        document.getElementById("temperature").value = (c.temperature_2m * 9/5 + 32).toFixed(1);
        document.getElementById("pressure").value = c.pressure_msl.toFixed(1);
        document.getElementById("humidity").value = c.relative_humidity_2m.toFixed(1);
        document.getElementById("elevation").value = (data.elevation * 3.28084).toFixed(0);
        log("Weather auto-filled successfully.");
      })
      .catch(e => log("Fetch error: " + e));
  }, err => log("Location error: " + err.message));
}

function calculateDensityAltitude(tempF, pressure, humidity, elevationFt) {
  const tempC = (tempF - 32) * 5/9;
  const pressureInHg = pressure * 0.02953;
  const seaLevelPressure = 29.92;
  const lapseRate = 0.0019812;
  const standardTempK = 288.15;
  const altitudeM = elevationFt / 3.281;
  const vaporPressure = humidity / 100 * 6.11 * Math.exp((17.62 * tempC) / (243.12 + tempC));
  const virtualTempK = (tempC + 273.15) / (1 - (vaporPressure / (pressure * 10)) * (1 - 0.622));
  const DA = (standardTempK / lapseRate) * (1 - Math.pow(pressureInHg / seaLevelPressure, 0.190284)) - altitudeM;
  return DA.toFixed(0);
}

function calculate() {
  const size = parseFloat(document.getElementById("targetSize").value);
  const dist = parseFloat(document.getElementById("distance").value);
  const hold = parseFloat(document.getElementById("windHold").value);
  const temp = parseFloat(document.getElementById("temperature").value);
  const press = parseFloat(document.getElementById("pressure").value);
  const hum = parseFloat(document.getElementById("humidity").value);
  const elev = parseFloat(document.getElementById("elevation").value);

  if ([size, dist, hold, temp, press, hum, elev].some(isNaN)) {
    alert("Please fill in all fields.");
    return;
  }

  const targetMIL = (size / 36) / (dist / 1000);
  const budget = targetMIL / 2;
  const error = budget - hold;
  const DA = calculateDensityAltitude(temp, press, hum, elev);

  document.getElementById("result").textContent =
    `Target Size: ${targetMIL.toFixed(3)} mils\n` +
    `Wind Budget: ±${budget.toFixed(3)} mils\n` +
    `Safe Wind Call Error: ±${error.toFixed(3)} mils\n` +
    `Density Altitude: ${DA} ft`;
}
</script>

</body>
</html>
